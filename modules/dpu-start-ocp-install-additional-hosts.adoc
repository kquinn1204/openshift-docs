// Module included in the following assemblies:
//
// * hardware_enablement/dpu-hardware-offload.adoc

:_content-type: PROCEDURE
[id="installing-on-dpu-hosts_{context}"] 
= Installing {product-title} on the DPU hosts

Install {product-title} on the DPU hosts by using this procedure carried out on the installer node. 
[NOTE]
====
The example output reflects the installation on one DPU node. 
====

.Procedure  

. Export the API URL environment variable: 
+
[source,terminal]
----
$ export API_URL=http://<Installer_FQDN>:8080/api/assisted-install/v2
----

. Export the CLUSTER_UUID environment variable: 
+
[source,terminal]
----
$ export CLUSTER_ID=<CLUSTER_UUID> 
----

. Get the INFRAENV id. 
+
[source,terminal]
----
$ curl --silent "$API_URL/infra-envs?cluster_id=$CLUSTER_ID" | jq '.[] .id' 
----
+
.Example output
+
[source,terminal]
----
aff04425-8f9f-44bb-8c4b-b83d689a10a4
----

. Export the `INFRAENV` environment variable:
+
[source,terminal]
----
$ export INFRAENV=aff04425-8f9f-44bb-8c4b-b83d689a10a4
----

.. Get all host and hostnames registered to the INFRAENV. 
+
[source,terminal]
----
$ curl --silent "$API_URL/infra-envs/$INFRAENV/hosts" | jq '.[] |  { id: .id, requested_hostname: .requested_hostname}'
----
+
.Example output
+
[source,terminal]
----
{
  "id": "acfa0fe6-6399-cff8-d344-fe635c3c029c",
  "requested_hostname": "localhost"
}
{
  "id": "9fd88bba-bd3d-44f0-9399-3750c31922b9",
  "requested_hostname": "master-3"
}
{
  "id": "a7823fea-9f80-4c11-aefb-ad6e96b1b4b2",
  "requested_hostname": "master-1"
}
{
  "id": "2b461591-27dc-4531-9a9b-ee33e98ecd6f",
  "requested_hostname": "master-2"
}
----
+
[NOTE]
====
You cannot install with hostname set to `localhost`. This needs to be changed. 
====

.. Set the `localhost` hostname to the `id`:  
+
[source,terminal]
----
$ curl --silent -X PATCH   "$API_URL/infra-envs/$INFRAENV/hosts/$HOST_ID"   -H 'accept: application/json'   -H 'Content-Type: application/json'   -d '{\n "host-role": "worker" "host_name": "worker-bf" }' 
----

.. Verify the hostname is set:
+
[source,terminal]
----
$ curl --silent "$API_URL/infra-envs/$INFRAENV/hosts" | jq '.[] |  { id: .id, requested_hostname: .requested_hostname}'
----
+
.Example output
+
[source,terminal]
----
{
  "id": "acfa0fe6-6399-cff8-d344-fe635c3c029c",
  "requested_hostname": "worker-bf"
}
{
  "id": "9fd88bba-bd3d-44f0-9399-3750c31922b9",
  "requested_hostname": "master-3"
}
{
  "id": "a7823fea-9f80-4c11-aefb-ad6e96b1b4b2",
  "requested_hostname": "master-1"
}
{
  "id": "2b461591-27dc-4531-9a9b-ee33e98ecd6f",
  "requested_hostname": "master-2"
}
----

. Start the installation.

.. Set the `HOST_ID`:
+
[source,terminal]
----
$ HOST_ID=acfa0fe6-6399-cff8-d344-fe635c3c029c
----

.. Make a POST request to the API using `curl` to start the installation: 
+
[source,terminal]
----
$ curl -X POST --silent "$API_URL/infra-envs/$INFRAENV/hosts/$HOST_ID/actions/install" | jq .
----

. Verify the installation status.

.. Set the `HOST_ID`:
+
[source,terminal]
----
$ HOST_ID=acfa0fe6-6399-cff8-d344-fe635c3c029c
----

.. Use `curl` to verify the status of the install: 
+
[source,terminal]
----
$ curl --silent "$API_URL/infra-envs/$INFRAENV/hosts/$HOST_ID" | jq '.status'
---- 

.. Verify the progress of the installation:
+
[source,terminal]
----
$ curl --silent "$API_URL/infra-envs/$INFRAENV/hosts/$HOST_ID" | jq '.progress'
---- 

. Approve the certificate request.
+
[NOTE]
====
Two certificate requests are generated and both need approved. The first one generated is the `kube-apiserver-client-kubelet` certificate request. Once this is approved a second certificate request the `kubelet-serving` is generated. 
====

.. Get the certificate request: 
+
[source,terminal]
----
$ oc get csr
---- 

.. Approve the `kube-apiserver-client-kubelet` certificate request:
+
[source,terminal]
----
$ oc adm certificate approve <csr_name>
---- 

.. Approve the `kubelet-serving` certificate request:
+
[source,terminal]
----
$ oc adm certificate approve <csr_name>
---- 

.. Verify that both certificates are issued and approved: 
+
[source,terminal]
----
$ oc get csr
---- 

. Verify the DPU node now exists:
+
[source,terminal]
----
$ oc get csr
---- 
+
.Example output
+
[source,terminal]
----
NAME                      STATUS    ROLES            AGE       VERSION
worker-bf                 Ready     worker           35s        v1.23.3+bba255d
master-0                  Ready     master,worker    108m       v1.23.3+bba255d
master-1                  Ready     master,worker    108m       v1.23.3+bba255d
master-2                  Ready     master,worker    89m        v1.23.3+bba255d
---- 

{product-title} is now succesfully installed on the DPU node. 

Post installation the Assisted Installer UI is broken. Resolve as follows.

. Connect to the Assisted Installer database: 
+
[source,terminal]
----
$ podman exec -ti assisted-installer-db bash 
----

. Run the following `psql` command:  
+
[source,terminal]
----
$ psql installer admin
----

. Update the Assisted Installer cluster status with the following command:
+
[source,terminal]
----
installer => update clusters set kind='Cluster', status='installed' where id='<CLUSTER UUID>'; 
----