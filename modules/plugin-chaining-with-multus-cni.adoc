// Module included in the following assemblies:
//
// networking/multiple_networks/about-chaining.adoc

:_mod-docs-content-type: PROCEDURE
[id="configuring-plugin-chaining-with-multus-cni_{context}"]
= Configuring plugin chaining with Multus CNI

Plugin chaining allows you to configure multiple CNI plugins to be applied sequentially to the same network interface. This approach is useful when you need to implement complex network configurations, such as routing traffic over different network paths or creating isolated networks for specialized traffic types.

For instance, in a telco environment, you might have the following requirements:

* SIP traffic (Voice over IP) must always be routed over a dedicated SIP network for optimized performance.
* Management traffic must go over a separate management network for administrative purposes.

Consider a telco application where SIP (telephony) traffic must be isolated from other types of traffic for example management or data traffic. This requires two networks:

* SIP Network: Handles all telephony traffic to ensure quality of service (QoS) and low latency.
* Management Network: Handles administrative traffic such as monitoring and configuration.

In this case, you can configure a pod with two interfaces:

* `eth1` for management traffic, routed through the management network.
* `eth2` for SIP traffic, routed through the SIP network.

Following this example you can use plugin chaining with Multus CNI, to attach both interfaces to the pod and use source-based routing to ensure SIP traffic is only routed through `eth2` while all other traffic flows over `eth1`.

.Prerequisites

* Install the OpenShift CLI (`oc`).
* An account with `cluster-admin` privileges.

.Procedure

. Create the `telco-app` namespace by running the following command:
+
[source,terminal]
----
$ oc create namespace telco-app
----

. Create NetworkAttachmentDefinition for Management Network

.. Create a YAML file, such as `management.yaml`, to define a NetworkAttachmentDefinition (NAD) that configures a new interface, `eth1`, with the following configuration:
+
[source,yaml]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: management-net
  namespace: telco-app
spec:
  config: '{
    "cniVersion": "1.0.0",
    "name": "management-net",
    "plugins": [
      {
        "type": "macvlan",
        "master": "br-ex",
	"vlan": 100,
        "mode": "bridge",
        "ipam": {
          "type": "static",
          "addresses": [
            {
              "address": "192.168.100.10/24",
              "gateway": "192.168.100.1"
            }
          ]
        }
      },
      {
        "type": "route-override",
        "table": 100,
        "srcRules": [
          {
            "from": "192.168.100.10/32",
            "table": 100
          }
        ],
        "routes": [
          { "dst": "0.0.0.0/0", "gw": "192.168.100.1" }
        ]
      }
    ]
  }'
----

. Create a chained NAD by running the following command:
+
[source,terminal]
----
$ oc apply -f management.yaml
----

. Create NetworkAttachmentDefinition for SIP Network.

.. Create a YAML file, such as `sip.yaml`, to define a NetworkAttachmentDefinition (NAD) that configures a new interface, `eth2`, with the following configuration:
+
[source,yaml]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: sip-net
  namespace: telco-app
spec:
  config: '{
    "cniVersion": "1.0.0",
    "name": "sip-net",
    "plugins": [
      {
        "type": "macvlan",
        "master": "br-ex",
        "vlan": 200,
        "mode": "bridge",
        "ipam": {
          "type": "static",
          "addresses": [
            {
              "address": "192.168.200.10/24",
              "gateway": "192.168.200.1"
            }
          ]
        }
      },
      {
        "type": "route-override",
        "table": 200,
        "srcRules": [
          {
            "from": "192.168.200.10/32",
            "table": 200
          }
        ],
        "routes": [
          { "dst": "0.0.0.0/0", "gw": "192.168.200.1" }
        ]
      }
    ]
  }'
----

. Create the chained NAD by running the following command:
+
[source,terminal]
----
$ oc apply -f sip.yaml
----

.  Attach the NAD to a pod by creating a Pod definition file, such as `pod.yaml`, with the following configuration:
+
[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: telco-app-pod
  namespace: telco-app
  labels:
    app: telco-app
  annotations:
    k8s.v1.cni.cncf.io/networks: '[
      { "name": "management-net", "interface": "eth1" },
      { "name": "sip-net", "interface": "eth2" }
    ]'
spec:
  securityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
  containers:
  - name: app-container
    image: centos/tools
    command: ["sleep", "infinity"]
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      runAsUser: 1000
      runAsGroup: 1000
----

. Create the pod by running the following command:
+
[source,terminal]
----
$ oc apply -f pod.yaml
----

.Verification

. Run the following command to list all network interfaces and their assigned IP addresses inside the `telco-app-pod`. This verifies that the pod has multiple network interfaces configured as expected:
+
[source,terminal]
----
$ oc exec -it telco-app-pod -n telco-app -- ip a
----

. Run the following command to inspect the IP routing rules inside the `telco-app-pod`. This displays the source-based routing rules applied within the pod to ensure SIP traffic is routed through `eth2`:
+
[source,terminal]
----
$ oc exec -it telco-app-pod -n telco-app -- ip rule show
----

. Run the following command to view the routing table (Table 200) inside the `telco-app-pod`. This verifies that traffic destined for the SIP network is correctly routed according to the source-based routing rules:
+
[source,terminal]
----
$ oc exec -it telco-app-pod -n telco-app -- ip route show table 200
----

. Run the following command to send an HTTP HEAD request to sip-server.example.com from the telco-app-pod, explicitly using the `eth2` interface. This helps verify that SIP traffic is correctly routed through the designated network interface:
+
[source,terminal]   
----
$ oc exec -it telco-app-pod -n telco-app -- curl -I --interface eth2 sip-server.example.com
----

. Run the following command to send an HTTP HEAD request to example.com from the telco-app-pod, explicitly using the `eth1` interface. This helps verify that non-SIP traffic is correctly routed through the management network:
+
[source,terminal]
----
$ oc exec -it telco-app-pod -n telco-app -- curl -I --interface eth1 example.com
----

The first command should return a response from the SIP server, while the second command should return a response from the default server.