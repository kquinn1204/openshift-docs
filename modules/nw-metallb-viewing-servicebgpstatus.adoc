:_mod-docs-content-type: PROCEDURE
[id="nw-viewing-service-bgp-status_{context}"]
= Viewing ServiceBGPStatus

[role="_abstract"]
You can verify BGP advertisement status for your services by viewing the `ServiceBGPStatus` custom resource, which shows which BGP peers are receiving advertisements from each node. This is essential for debugging connectivity in Telco environments.

The `ServiceBGPStatus` CR provides insights into which BGP peers a specific service is being advertised to from a given node. This is a crucial tool for network administrators in Telco environments to verify BGP advertisement and debug connectivity.

[NOTE]
====
`ServiceBGPStatus` resources are created in the `metallb-system` namespace, not in the namespace where your LoadBalancer service is deployed. Always query these resources with `-n metallb-system`.
====

.Prerequisites

* You have an {product-title} cluster with the MetalLB Operator installed.
* You have created a MetalLB instance. For example:
+
[source,yaml]
----
apiVersion: metallb.io/v1beta1
kind: MetalLB
metadata:
  name: metallb
  namespace: metallb-system
spec: {}
----
+
This deploys the MetalLB controller and speaker pods required for status monitoring.
+
This example shows how to configure MetalLB for BGP mode, deploy a service, and view the `ServiceBGPStatus` to verify BGP advertisements.

.Procedure

. Create an IPAddressPool for BGP:
+
[source,yaml]
----
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: bgp-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.122.210-192.168.122.220
  autoAssign: true
----

. Apply the `IPAddressPool` configuration:
+
[source,terminal]
----
$ oc apply -f ipaddresspool.yaml
----

. Configure a BGP peer to connect to your BGP router:
+
[source,yaml]
----
apiVersion: metallb.io/v1beta2
kind: BGPPeer
metadata:
  name: bgp-peer
  namespace: metallb-system
spec:
  myASN: 64501
  peerASN: 64500
  peerAddress: 192.168.1.1
----
+
* The `spec:peerAddress` field should be set to the IP address of your BGP router.

. Apply the BGPPeer configuration:
+
[source,terminal]
----
$ oc apply -f bgppeer.yaml
----

. Create a BGP advertisement to advertise the pool:
+
[source,yaml]
----
apiVersion: metallb.io/v1beta1
kind: BGPAdvertisement
metadata:
  name: bgp-advertisement
  namespace: metallb-system
spec:
  ipAddressPools:
  - bgp-pool
----

. Apply the BGPAdvertisement configuration:
+
[source,terminal]
----
$ oc apply -f bgpadvertisement.yaml
----

. Deploy an application and expose it with a LoadBalancer service. For this example, create a simple test application:
+
[source,yaml]
----
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: test-app
  template:
    metadata:
      labels:
        app: test-app
    spec:
      containers:
      - name: test-app
        image: quay.io/openshifttest/hello-openshift:multiarch
        ports:
        - containerPort: 8080
----

. Apply the deployment:
+
[source,terminal]
----
$ oc apply -f deployment.yaml
----

. Create a LoadBalancer service for the application:
+
[source,yaml]
----
apiVersion: v1
kind: Service
metadata:
  name: test-service
  namespace: default
spec:
  selector:
    app: test-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: LoadBalancer
----
+
[IMPORTANT]
====
`ServiceBGPStatus` resources are created automatically only when the service has at least one ready endpoint (running pod). Ensure your application pods are running before checking for ServiceBGPStatus resources.
====

. Apply the service configuration:
+
[source,terminal]
----
$ oc apply -f service.yaml
----

. Verify the service received an external IP:
+
[source,terminal]
----
$ oc get svc test-service -n default
----
+
The output is similar to the following:
+
[source,terminal]
----
NAME           TYPE           CLUSTER-IP       EXTERNAL-IP       PORT(S)        AGE
test-service   LoadBalancer   172.30.116.108   192.168.122.210   80:32431/TCP   2m
----

. View the ServiceBGPStatus resources:
+
[source,terminal]
----
$ oc get servicebgpstatus -n metallb-system
----
+
The output is similar to the following:
+
[source,terminal]
----
NAME                  NODE       SERVICE NAME   SERVICE NAMESPACE
bgp-xxxxx             worker0    test-service   default
----
+
[NOTE]
====
ServiceBGPStatus resources are created with generated names. Use labels to find the status for your service:

[source,terminal]
----
$ oc get servicebgpstatus -n metallb-system -l metallb.io/service-name=test-service
----
====

. View the details of the ServiceBGPStatus CR for your service:
+
[source,terminal]
----
$ oc get servicebgpstatus bgp-xxxxx -n metallb-system -o yaml
----
+
The output is similar to the following:
+
[source,yaml]
----
apiVersion: metallb.io/v1beta1
kind: ServiceBGPStatus
metadata:
  name: bgp-xxxxx
  namespace: metallb-system
  labels:
    metallb.io/node: worker0
    metallb.io/service-name: test-service
    metallb.io/service-namespace: default
status:
  node: worker0
  peers:
  - bgp-peer
  serviceName: test-service
  serviceNamespace: default
----
+
The output includes the following important fields:
+
* `metadata.labels.metallb.io/node` indicates the node that is advertising the service via BGP.
* `metadata.labels.metallb.io/service-name` identifies the service being advertised.
* `metadata.labels.metallb.io/service-namespace` identifies the namespace of the service being advertised.
* `status.node` confirms the name of the node advertising the service.
* `status.peers` lists the names of the BGPPeer resources to which the service is being advertised. This is useful for confirming that the advertisement is reaching the intended peers.
* `status.serviceName` indicates the name of the service being advertised.
* `status.serviceNamespace` indicates the namespace of the service being advertised.
